#!/bin/sh
set -eu

echo "► Starting Main Entrypoint..."

# Bypass Doppler for healthchecks (never depend on secrets for liveness/readiness)
case "${1:-}" in
  healthcheck-liveness|healthcheck-readiness|php-fpm-healthcheck)
    echo "► Bypassing Doppler for healthcheck. cmd: $*"
    exec "$@"
    ;;
esac

# Run Dockerfile's CMD (default: php-fpm)
if [ -z "${DOPPLER_TOKEN:-}" ]; then
  echo "Doppler token non défini. Commande exécutée sans Doppler. cmd: $*"
  exec "$@"
else
  echo "► Starting application with Doppler. cmd: $*"
  exec doppler run -- "$@"
fi